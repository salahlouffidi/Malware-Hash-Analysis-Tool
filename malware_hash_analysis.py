import requests
import datetime

# Function to fetch file list from Malshare for a specific date
def fetch_file_list(date):
    url = f"https://malshare.com/daily/{date}/malshare_fileList.{date}.all.txt"
    response = requests.get(url)
    if response.status_code == 200:
        return response.text.splitlines()
    else:
        return []

# Function to query a hash on VirusTotal
def query_virustotal(hash):
    # Replace 'YOUR_API_KEY' with your actual VirusTotal API key
    url = f"https://www.virustotal.com/api/v3/files/{hash}"
    headers = {"x-apikey": "YOUR_API_KEY"}
    response = requests.get(url, headers=headers)
    if response.status_code == 200:
        return response.json()
    else:
        return {}

# Input date in YYYY-MM-DD format
input_date = input("Enter a date (YYYY-MM-DD): ")
date = datetime.datetime.strptime(input_date, "%Y-%m-%d").date()

# Loop through dates from 2018 until today
current_date = datetime.date(2018, 1, 1)
while current_date <= date and current_date <= datetime.datetime.now().date():
    formatted_date = current_date.strftime("%Y-%m-%d")
    file_list = fetch_file_list(formatted_date)

    for hash in file_list:
        vt_result = query_virustotal(hash)
        # Process the VirusTotal result as per your requirements
        # Extract the YARA rule and name from the result and do further processing
        if vt_result:
            yara_rule = vt_result.get("data", {}).get("attributes", {}).get("yara")
            name = vt_result.get("data", {}).get("attributes", {}).get("names", [])[0] if vt_result.get("data", {}).get("attributes", {}).get("names") else None
            
            # Perform further processing with the YARA rule and name
            
    current_date += datetime.timedelta(days=1)
